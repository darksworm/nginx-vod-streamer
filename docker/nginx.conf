load_module "modules/ngx_rtmp_module.so";
daemon off;
worker_processes auto;

events {
    worker_connections 2048;
}

rtmp {
    server {
        # Listen on standard RTMP port
        listen 1935;
        chunk_size 4000;

        application show {
            live on;

            # disable consuming the stream from nginx as rtmp
            deny play all;

            # Turn on HLS
            hls on;
            hls_path /mnt;
            hls_fragment 4;
            hls_playlist_length 60;
        }
    }
}

http {
    limit_req_zone $binary_remote_addr zone=one:10m rate=120r/m;
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    sendfile off;
    tcp_nopush on;
    tcp_nodelay on;

    client_body_buffer_size 16k;
    client_max_body_size 2m;
    client_body_in_single_buffer on;
    client_header_buffer_size  1m;
    large_client_header_buffers 4 16k;

    directio 4m;
    directio_alignment 512;

    open_file_cache max=512 inactive=30s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 5;
    open_file_cache_errors on;

    default_type application/octet-stream;

    access_log /dev/stdout;
    error_log /dev/stdout info;

    ssl_certificate ssl/cert.pem;
    ssl_certificate_key ssl/privkey.pem;

    server {
        listen 80;
        server_name stream.emojigun.com;

        rewrite ^/(.*)$ https://stream.emojigun.com/$1 permanent;
    }

    server {
        listen 443 ssl default;
        listen 80 default;
        server_name _;

        return 444;
    }

    server {
        listen 443 ssl;
        server_name stream.emojigun.com;
        root /mnt/;

        # Disable cache
        add_header 'Cache-Control' 'no-cache';
        index index.html;
        default_type "text/html";

        client_body_timeout 20s;
        client_header_timeout 20s;

        types {
            application/dash+xml mpd;
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
            plain/text key;
        }

        location / {
            autoindex off;
            limit_req zone=one;
            limit_conn addr 10;
        }

        location /index.html {
            return 444;
        }
    }
}
